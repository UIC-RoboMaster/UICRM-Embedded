### **三、控制**  
在提供通讯协议前，需明确超级电容控制器工作过程及相关专有名词定义。  


#### **一、适配电容组类型**  
超级电容控制器支持三种类型的超级电容组，仅最高充电电压不同（最低电压均为3.5V）：  
- **类型1**：最高充电电压24V。  
- **类型2**：最高充电电压28V。  
- **类型3**：最高充电电压30V。  
**Note1**：用户需手动设置类型，控制器无自动检测能力，错误设置可能导致电容组与控制器不可逆损伤。  
**Note2**：RoboMaster赛事中，裁判系统电容管理模块电流检测芯片最大共模电压为28V，类型3存在风险，但因30V收益较高且部分战队反馈28V~30V未出现严重损坏，故保留此类型。  


#### **二、工作模式**  
控制器分为三种工作模式：**Work**、**Charge**、**Silent**，能量流动拓扑如下：  
```
负载
功率:Pc
功率,Ps 变换器 电容组
功率:Pb
电源
（能量流动方向与箭头一致时，P>0）
```  
**能量守恒公式**：\( P_b = P_c + P_s \)  

1. **Work模式**  
   - 目标：维持电源输入功率 \( P_b \) 恒定为用户设定值 \( P_{b\_Set} \)，即 \( P_{b\_Set} = P_b = P_c + P_s \)。  
   - **限制条件**：  
     - **低压限流**：电容组低压时限制充放电功率。  
     - **电压边界保护**：达到最高/最低电压时，仅维持电压恒定，拒绝充放电。  
     - **放电功率限制**：避免过大放电功率损坏控制器。  

2. **Charge模式**  
   - 目标：满足RoboMaster赛事“攒一波”需求，确保 \( P_{b\_Set} = P_b = P_c + P_s \) 且 \( P_s > 0 \)（专注充电）。  
   - **限制条件**：  
     - 低压时限制充电功率。  
     - 达到最高电压时，仅维持电压恒定，拒绝充电。  

3. **Silent模式**  
   - 目标：\( P_b = P_c \)（能量直接供给负载，不通过电容组存储）。  

**实时反馈**：当前工作模式通过OLED屏幕显示（字段：`Mode:`）。  


#### **三、电容组电压**  
- **特性**：控制器返回的电压经ESR修正，不代表真实电压，但更能反映剩余能量。  
- **剩余能量计算**：  
  \[
  \mu = \frac{U_{\text{cap}}^2 - U_{\text{min}}^2}{U_{\text{max}}^2 - U_{\text{min}}^2}
  \]  
  其中：\( \mu \) 为剩余能量百分比，\( U_{\text{cap}} \) 为当前电压，\( U_{\text{max}} \) 为最高电压，\( U_{\text{min}} = 3.5\text{V} \)。  
- **实时反馈**：电容组电压通过OLED屏幕显示（字段：`Vcap:`）。  


#### **四、工作强度**  
定义两种工作强度（百分比值）：  
- **工作强度1（\( \alpha_1 \)）**：充放电电流比率，\( \alpha_1 = \left| \frac{I_{\text{cap}}}{I_{\text{cap\_max}}} \right| \)。  
- **工作强度2（\( \alpha_2 \)）**：放电功率比率，\( \alpha_2 = \left| \frac{P_s}{P_{s\_\text{max}}} \right| \)。  
**限制**：  
- Exceed关闭时，\( \alpha_1 \)、\( \alpha_2 \) 均≤100%。  
- Exceed开启时，\( \alpha_1 \) 可≤135%（\( \alpha_2 \) 仍≤100%）。  


#### **五、Exceed模式**  
- **功能**：突破电容组限制，基于控制器器件可持续额定参数提升性能（维持恒定 \( P_s \) 的能力提升35%）。  
- **风险**：不考虑电容组寿命，长时间开启可能导致过热或损坏。  
- **使用限制**：  
  - 必须配备散热片。  
  - 单次持续时间≤10秒，间隔需等待控制器与电容组充分冷却。  
- **实时反馈**：Exceed状态通过OLED屏幕显示（字段：`Exceed:`，0为关闭，1为开启）。  


#### **六、安全管理**  
控制器实时监测自身状态，按问题严重程度分为5个安全等级：  
- **0**：安全（无异常）。  
- **1**：警告（不干预业务，仅反馈信息）。  
- **2**：风险（强制停止变换器，恢复后允许工作）。  
- **3**：危险（强制停止，需手动重置）。  
- **4**：不可逆损伤（需硬件检修）。  

**检测项及对应等级**：  
| 检测项       | 涉及安全等级          | 说明                                                                 |
|--------------|-----------------------|----------------------------------------------------------------------|
| 固件错误     | 0、1、4               | 达到4级需立即联系硬件工程师。                                       |
| CAN错误      | 0、2                  | 达到2级需检查通讯协议与连接。                                       |
| 过热保护     | 0、1、2、4            | 达到2级需加强散热，4级需硬件检修。                                  |
| 校准错误     | 0、3                  | 达到3级可尝试重置，无效则需硬件检修。                               |
| 电压错误     | 0、2                  | 需确保电池电压19.5V~27.5V，电容组电压3.5V~设定最高值。               |
| 电流错误     | 0、1、2、4            | 达到4级需硬件检修。                                                 |
| 功率错误     | 0、1、2、4            | 达到2/4级需硬件检修。                                               |
| 采样错误     | 0、1、3               | 达到3级需硬件检修。                                                 |

**实时反馈**：安全等级通过OLED屏幕8位数字显示（从左至右依次对应上述8个检测项的等级）。  


#### **七、通讯协议**  
控制器通过CAN总线与主控交互，支持以下帧类型：  

| 帧类型       | ID   | 方向       | 功能及数据格式                                                                 |
|--------------|------|------------|-------------------------------------------------------------------------------|
| **就绪帧**   | 0X005| 控制器→主控 | 1字节：0xFF=可用，0x00=不可用（上电或安全等级变化时发送）。                   |
| **初始化帧** | 0X002| 主控→控制器 | 1字节：0x00=类型1，0x01=类型2，0x02=类型3（仅上电后接受一次）。               |
| **反馈帧**   | 0X003| 控制器→主控 | 6字节：包含ESR修正电压、工作强度1/2、电源输入功率（每500ms传输一次）。        |
| **控制帧**   | 0X004| 主控→控制器 | 3字节：设置 \( P_{b\_Set} \)、Exceed状态（0x00=关闭，0x01=开启）、工作模式。   |
| **安全提示帧** | 0X001| 控制器→主控 | 8字节：各检测项安全等级（初始化或等级变化时发送）。                          |

**Tips**：控制帧权限低于控制器内置安全管理逻辑，重复发送可能影响性能。


### **通讯协议详解**  
控制器通过CAN总线与主控进行数据交互，支持以下**5种帧类型**，均为标准数据帧：  


#### **1. 就绪帧（控制器→主控）**  
- **ID**：`0X005`  
- **数据长度**：1字节  
- **功能**：  
  - 反馈控制器工作状态，**仅在以下场景发送**：  
    - 控制器上电后首次发送。  
    - 安全等级变化导致控制器可用状态变更时（如从“安全”转为“风险”时可能发送`0x00`表示不可用）。  
- **位值释义**：  
  | 位值偏移 | 释义 |  
  |----------|------|  
  | 0~7      | `0xFF`：控制器已就绪，可进行CAN数据收发<br>`0x00`：控制器不可用，接收的所有CAN帧将被忽略 |  


#### **2. 初始化帧（主控→控制器）**  
- **ID**：`0X002`  
- **数据长度**：1字节  
- **功能**：  
  - 主控**仅在上电后**向控制器发送一次，用于设置超级电容组类型。  
  - **类型与位值对应关系**：  
    | 位值 | 电容组类型 | 最高充电电压 |  
    |------|------------|--------------|  
    | `0x00` | 类型1      | 24V          |  
    | `0x01` | 类型2      | 28V          |  
    | `0x02` | 类型3      | 30V          |  
- **注意**：控制器无自动检测电容组类型的能力，需用户手动设置，错误设置可能导致元件损坏。  


#### **3. 反馈帧（控制器→主控）**  
- **ID**：`0X003`  
- **数据长度**：6字节（48位）  
- **功能**：  
  - 实时反馈控制器关键运行参数，**每500ms传输一帧**。  
- **位值释义**：  
  | 位值偏移 | 字段         | 释义及格式说明 |  
  |----------|--------------|----------------|  
  | 0~7      | 电压高8位    | ESR修正后电容组电压值 ×100（取整，忽略小数）的高8位<br>例：电压12.34V→1234→高8位为`0x04`（1234的十六进制为`0x04D2`） |  
  | 8~15     | 电压低8位    | 同上，低8位为`0xD2` |  
  | 16~23    | 工作强度1    | 实际工作强度1（α₁）×100（取整）<br>例：α₁=0.8147→81→二进制`0x51` |  
  | 24~31    | 工作强度2    | 实际工作强度2（α₂）×100（取整） |  
  | 32~39    | 电源功率高8位| 电源输入功率（Pb）×100（取整）的高8位<br>例：功率12.34W→1234→高8位`0x04` |  
  | 40~47    | 电源功率低8位| 同上，低8位`0xD2` |  


#### **4. 控制帧（主控→控制器）**  
- **ID**：`0X004`  
- **数据长度**：3字节（24位）  
- **功能**：  
  - 主控向控制器下发控制指令，**权限低于控制器内置安全管理逻辑**（即安全管理优先执行）。  
  - **建议**：仅在参数变更时发送，避免重复发送影响性能。  
- **位值释义**：  
  | 位值偏移 | 字段         | 释义及格式说明 |  
  |----------|--------------|----------------|  
  | 0~7      | \( P_{b\_Set} \) | 目标电源输入功率值（单位：W），直接以字节值表示<br>例：设置Pb_Set=100W→字节值`0x64` |  
  | 8~15     | Exceed状态   | `0x00`：Exceed失能（关闭）<br>`0x01`：Exceed使能（开启） |  
  | 16~23    | 工作模式     | `0x00`：Silent模式<br>`0x01`：Work模式<br>`0x02`：Charge模式 |  


#### **5. 安全提示帧（控制器→主控）**  
- **ID**：`0X001`  
- **数据长度**：8字节（64位）  
- **功能**：  
  - 反馈控制器各检测项的安全等级，**仅在以下场景发送**：  
    - 控制器初始化完成后首次发送。  
    - 任意检测项的安全等级发生变化时（如过热保护从“警告”升级为“风险”）。  
- **位值释义**：  
  | 位值偏移 | 检测项         | 安全等级范围（0~4） |  
  |----------|----------------|--------------------|  
  | 0~7      | 固件错误       | 0（安全）、1（警告）、4（不可逆损伤） |  
  | 8~15     | CAN错误        | 0（安全）、2（风险） |  
  | 16~23    | 过热保护       | 0（安全）、1（警告）、2（风险）、4（不可逆损伤） |  
  | 24~31    | 校准错误       | 0（安全）、3（危险） |  
  | 32~39    | 电压错误       | 0（安全）、2（风险） |  
  | 40~47    | 电流错误       | 0（安全）、1（警告）、2（风险）、4（不可逆损伤） |  
  | 48~55    | 功率错误       | 0（安全）、1（警告）、2（风险）、4（不可逆损伤） |  
  | 56~63    | 采样错误       | 0（安全）、1（警告）、3（危险） |  


### **关键交互逻辑总结**  
1. **初始化流程**：  
   - 控制器上电后发送**就绪帧**（`0X005`）→ 主控发送**初始化帧**（`0X002`）设置电容组类型 → 控制器发送**安全提示帧**（`0X001`）反馈初始安全状态。  
2. **实时监控**：  
   - 控制器周期性发送**反馈帧**（`0X003`）→ 若安全等级变化，立即发送**安全提示帧**（`0X001`）。  
3. **控制指令**：  
   - 主控通过**控制帧**（`0X004`）动态调整工作模式、功率目标及Exceed状态，但需遵循控制器安全管理逻辑。  